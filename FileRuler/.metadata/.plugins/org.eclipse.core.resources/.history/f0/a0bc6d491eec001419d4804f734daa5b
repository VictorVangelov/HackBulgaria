package com.hackbulgaria.fileruler;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.net.URL;
import java.net.URLConnection;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.HashMap;


import org.apache.commons.io.FilenameUtils;
import org.apache.http.client.HttpResponseException;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.google.gson.JsonObject;
import com.mashape.unirest.http.Unirest;
import com.mashape.unirest.http.exceptions.UnirestException;

public class ImageFactory extends Thread {

	static String name;
	static Path path;
	static URL url;
	HashMap<String, Double> imaggaTags = new HashMap<String, Double>();
	ArrayList<String> fileRulerTags = new ArrayList<String>();
	JsonObject imaggaJSON;
	static String defaultPicDBFolder = "/home/shosho/Downloads/FileRulerPicDB/";
	String tag = "";
	String temp = "";
	double confidencee;

	public static void main(String[] args) throws IOException {
		generateAllImages();
	}

	private static String getImaggaResponce(String url)
			throws HttpResponseException, IOException {
		String imaggaEndPoint = "http://api.imagga.com/v1/tagging?url=";
		com.mashape.unirest.http.HttpResponse<String> response;
		try {
			response = Unirest
					.get(imaggaEndPoint.concat(url))
					.header("accept", "application/json")
					.header("authorization",
							"Basic YWNjX2YzYTVkYTc4N2ZmZTZmMDo0MmIwNWZhMTcwNjlhOGMzMDgwMjkyNDBkNjkwODU0Mw==")
					.asString();
			return response.getBody();
		} catch (UnirestException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return "";

	}

	public ImageFactory(String filePathAndName) {
		super(filePathAndName);
	}

	public static String readFrom(File inputFile) throws IOException {
		StringBuilder sb = new StringBuilder();
		BufferedReader br = new BufferedReader(new FileReader(inputFile));
		String currentLineOfFile;
		while ((currentLineOfFile = br.readLine()) != null) {
			sb.append(currentLineOfFile);
		}
		br.close();
		return sb.toString();
	}

	@Override
	public void run() {
		// System.out.println(getName());
		name = FilenameUtils.getBaseName(getName());
		String ext = FilenameUtils.getExtension(getName());
		name += "." + ext;
		path = Paths.get((defaultPicDBFolder + name));
		try {
			if (!getImaggaResponce(getName()).equals("")) {
				try {
					Thread.sleep(1500);
				} catch (InterruptedException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				String jsonContent = getImaggaResponce(getName());
				JSONObject obj = new JSONObject(jsonContent);
				JSONArray arr = obj.getJSONArray("results");
				System.out.println(jsonContent);
				JSONObject imaggaInformation = arr.getJSONObject(0);
				JSONArray tagsAndConfidence = (JSONArray) imaggaInformation
						.get("tags");
				for (int i = 0; i < tagsAndConfidence.length() - 1; i++) {
					try {
						tag = tagsAndConfidence.getJSONObject(i).getString(
								"tag");
						temp = (String) tagsAndConfidence.getJSONObject(i).get(
								"confidence");
						confidencee = Double.parseDouble(temp);

					} catch (ClassCastException e) {
						confidencee = 0;
					}
					imaggaTags.put(tag, confidencee);
				}
				url = new URL(getName());
				//createFileInHDD(getName());

				ImagesCollection.imagesCollection.add(new Image(new URL(
						getName()), path, name, imaggaTags));
			}

		} catch (JSONException e) {
			System.out.println(e.getMessage());
			e.printStackTrace();
		} catch (IOException e) {
			System.out.println(e.getMessage());
			e.printStackTrace();
		}
	}

/*	static void createFileInHDD(String urll) {
		InputStream in = null;
		FileOutputStream fos = null;
		try {
			URL url = new URL(urll);
			URLConnection connection = url.openConnection();
			in = connection.getInputStream();
			fos = new FileOutputStream(new File(String.format("%s%s.jpg",
					defaultPicDBFolder, name)));
			path = Paths.get(new URI(String.format("%s%s.jpg",
					defaultPicDBFolder, name)));
			byte[] buf = new byte[512];
			while (true) {
				int len = in.read(buf);
				if (len == -1) {
					break;
				}
				fos.write(buf, 0, len);
			}

		} catch (Exception e) {
			e.getMessage();
			e.printStackTrace();
		} finally {
			try {
				if (in != null) {
					in.close();
				}
				if (fos != null) {
					fos.flush();
					fos.close();
				}

			} catch (Exception e2) {
				System.out.println(e2.getMessage());
				e2.printStackTrace();
			}
		}
	}*/

	static void generateAllImages() throws IOException {
		File allUrls = new File("urls.txt");
		String allURLS[] = readFrom(allUrls).split(";");
		for (String pathToFile : allURLS) {
			new ImageFactory(pathToFile).start();

		}
	}

}
